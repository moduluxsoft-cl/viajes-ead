# Etapa 1: build
FROM node:22-alpine AS builder

WORKDIR /app

# Copiamos los package.json del monorepo
COPY package.json package-lock.json ./
COPY packages/package.json ./packages/package.json

# Instalar dependencias
RUN npm ci

# Copiar el resto del código
COPY . .

# Build web (ajusta el script según tu package.json)
# Ejemplo: "build:web": "expo export --platform web"
RUN npm run build:web

# Etapa 2: servidor estático
FROM node:20-alpine

WORKDIR /app

# Instalar un server estático mínimo (puede ser serve o http-server)
RUN npm install -g serve

# Copiar solo el resultado de build
COPY --from=builder /app/packages/dist ./dist

# Variable de entorno para versionado (ver sección 5)
ARG APP_VERSION=0.0.0
ENV APP_VERSION=${APP_VERSION}

EXPOSE 3000

CMD ["serve", "dist", "-l", "3000"]